<html>
<head>
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
  <!--[if lte IE 8]>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.ie.css" />
  <![endif]-->
  <style type="text/css">
    #map { 
    	height: 600px; 
    	width: 80%;
    }
    #results { 
    	width: 18%;
		  position: absolute;
			top: 0;
			right: 0;
		}
		#results li span {
			cursor: pointer;
			color: blue;
			text-decoration: underline;
		}
		.active_result {
			background-color: #eee;
		}
  </style>

  <script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>

</head>
<body>
  <form method="get" action="#" id="search_form">
  	<input type="text" id="q" name="q" value="Tempe, Arizona" /><input type="submit" />
  </form>
  <div id="map"></div>	
  <ul id="results"></ul>

  <script type="text/javascript">

	  var query = "";
    var map = L.map('map'); //.setView([51.505, -0.09], 13);
    L.tileLayer('http://{s}.tile.cloudmade.com/4be2d4a8b7ae4a5e8ebc0558bb5d7db4/997/256/{z}/{x}/{y}.png', {
	    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery &copy; <a href="http://cloudmade.com">CloudMade</a>',
	    maxZoom: 18
		}).addTo(map);

    // Get url params
    var prmstr = window.location.search.substr(1);
		var prmarr = prmstr.split ("&");
		var params = {};
		for ( var i = 0; i < prmarr.length; i++) {
		    var tmparr = prmarr[i].split("=");
		    params[tmparr[0]] = tmparr[1];
		}

		// decode query param
		if(params["q"] && params["q"].length > 0){
			handleQuery(decodeURIComponent(params["q"]).replace(/\+/g, ' '));
		}
		else {
			if (navigator.geolocation)
	    {
	    	navigator.geolocation.getCurrentPosition(function(pos){
          // Move the map over
	    		map.setView([pos.coords.latitude,pos.coords.longitude],12);

	    		// AJAX request for checking where we are
					reverseLookup(pos.coords.latitude,pos.coords.longitude,18,function(xmlhttp) {
				  	// Decode response as JSON
						response = JSON.parse(xmlhttp.responseText);

						if(response.address){
							console.log(response.address);
              var loc = "";
              // Set search textbox to where we think we are
              if(response.address.suburb){
                loc += response.address.suburb+", ";
              }
              if(response.address.city){
                loc += response.address.city+", ";
              }
              if(response.address.state){
                loc += response.address.state+", ";
              }
              if(response.address.country){
                loc += response.address.country+", ";
              }
              document.getElementById("q").value = loc;
						}
            else{
              console.log("No reverse-lookup json");
            }
					});
	    	},function(error){
	    		console.log(error);
	    		updateMap("Tempe, Arizona",[[33.6569,-111.6801],[33.3133,-112.3276]])
	    	});
	    }
	    else {
			  updateMap("Tempe, Arizona",[[33.6569,-111.6801],[33.3133,-112.3276]])
	    }
		}

		function handleQuery(query){
			window.query = query;
			// AJAX request for geolocation of query
			forwardLookup(query,function(xmlhttp) {
		  	// Decode response as JSON
				response = JSON.parse(xmlhttp.responseText);
        console.log(response);
        console.log("SUP");

				if(response.length > 0){
					// Display all results in sidebar
					response.forEach(function(result,index){
						appendToResults(index,result.display_name);
					});

					// Fit map to bounds of first result
					showItem(0);
				}
				else {
					appendToResults("No Results");
				}
		  });

		}

		function forwardLookup(query,callback){
	    xmlhttp=new XMLHttpRequest();
	    xmlhttp.open("GET","http://nominatim.openstreetmap.org/search/"+encodeURIComponent(query)+"?format=json",true);
			xmlhttp.send();
			xmlhttp.onreadystatechange = function(){
			  if (xmlhttp.readyState==4 && xmlhttp.status==200) {
			  	callback(xmlhttp);
			  }
			}; 
		}

		function reverseLookup(lat,lon,zoom,callback){
	    xmlhttp=new XMLHttpRequest();
      request = "http://nominatim.openstreetmap.org/reverse?format=json&lat="+encodeURIComponent(lat)+"&lon="+encodeURIComponent(lon)+"&zoom="+encodeURIComponent(zoom);
	    xmlhttp.open("GET",request,true);
			xmlhttp.send();
			xmlhttp.onreadystatechange = function(){
			  if (xmlhttp.readyState==4 && xmlhttp.status==200) {
			  	callback(xmlhttp);
			  }
			}; 
		}

		function appendToResults(index,name){
			var item = document.createElement("li");
			item.innerHTML = "<span onclick=\"showItem('"+index+"');\">"+name+'</span>';
			item.id = "result_"+index;
			document.getElementById("results").appendChild(item);
		}

		function showItem(index){
			// Change this item to be the active one
			var results = document.getElementsByClassName("active_result")
			for(var i=0; i < results.length; i++){
				console.log(i);
				results[i].className = "";
			}
			document.getElementById("result_"+index).className = "active_result";

			// Update the map
			updateMap(query,[[response[index].boundingbox[0], response[index].boundingbox[2]],
			  [response[index].boundingbox[1], response[index].boundingbox[3]]]);
		}

		function updateMap(query,bounds){
			// Set search textbox to query
			document.getElementById("q").value = query;
			
			// Fit map to the GPS boundaries
			map.fitBounds(bounds);
		};

  </script>

</body>
</html>